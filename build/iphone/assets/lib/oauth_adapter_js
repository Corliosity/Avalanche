var OAuthAdapter=function(e){var t=e.consumerSecret,n=e.consumerKey,r=e.signatureMethod,i=null,s=null,o=null,u=null,a=null,f={consumerSecret:t,tokenSecret:""},l=null,c=null,h=null,p=null;this.loadAccessToken=function(e){Ti.API.debug("Loading access token for service ["+e+"].");var t=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,e+".config");if(t.exists()==0)return;var n=t.read();if(n==null)return;var r;try{r=JSON.parse(n.text)}catch(i){return}if(!r)return;r.accessToken&&(u=r.accessToken),r.accessTokenSecret&&(a=r.accessTokenSecret),Ti.API.debug("Loading access token: done [accessToken:"+u+"][accessTokenSecret:"+a+"].")},this.saveAccessToken=function(e){Ti.API.debug("Saving access token ["+e+"].");var t=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,e+".config");t==null&&(t=Ti.Filesystem.createFile(Ti.Filesystem.applicationDataDirectory,e+".config")),t.write(JSON.stringify({accessToken:u,accessTokenSecret:a})),Ti.API.debug("Saving access token: done.")},this.clearAccessToken=function(e){var t=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,e+".config");t==null&&(t=Ti.Filesystem.createFile(Ti.Filesystem.applicationDataDirectory,e+".config")),t.write(JSON.stringify({accessToken:null,accessTokenSecret:null})),u=null,a=null},this.isAuthorized=function(){return u!=null&&a!=null};var d=function(e,t){var i={action:e,method:t?t:"POST",parameters:[]};return i.parameters.push(["oauth_consumer_key",n]),i.parameters.push(["oauth_signature_method",r]),i};this.getPin=function(){return i},this.getRequestToken=function(e,t){f.tokenSecret="";var n=d(e);OAuth.setTimestampAndNonce(n),OAuth.SignatureMethod.sign(n,f);var r=Ti.Network.createHTTPClient();r.onload=function(){var e=OAuth.getParameterMap(r.responseText);s=e.oauth_token,o=e.oauth_token_secret,Ti.API.debug("request token got the following response: "+r.responseText),t(r.responseText)},r.onerror=function(e){Ti.API.debug(e),Ti.API.debug({error:"["+r.status+"] "+r.responseText}),t(null)},r.open("POST",e,!0),r.send(OAuth.getParameterMap(n.parameters))};var v=function(){Ti.API.debug("destroyAuthorizeUI");if(!l)return;try{h.removeEventListener("load",m),l.hide(),l.close(),l.remove(c),c.remove(h),h=null,c=null,l=null}catch(e){Ti.API.debug("Cannot destroy the authorize UI. Ignoring.")}},m=function(e){Ti.API.debug("authorizeUILoaded");var t=h.evalJS("window.document.querySelector('kbd[aria-labelledby=\"code-desc\"] > code').innerHTML");t&&(i=t,p&&p())};this.showAuthorizeUI=function(e,t){p=t,l=Ti.UI.createWindow({modal:!0,fullscreen:!0});var n=Ti.UI.create2DMatrix().scale(0);c=Ti.UI.createView({top:5,width:"99%",height:"600",border:5,backgroundColor:"white",borderColor:"#aaa",borderRadius:20,borderWidth:5,zIndex:-1,transform:n}),closeLabel=Ti.UI.createLabel({textAlign:"right",font:{fontWeight:"bold",fontSize:"12pt"},text:"(X)",top:10,right:12,height:14}),h=Ti.UI.createWebView({url:e,top:closeLabel.height+closeLabel.top,width:"97%",height:c.height-closeLabel.height-closeLabel.top-c.borderWidth*4,autoDetect:[Ti.UI.AUTOLINK_NONE]}),Ti.version<"1.7.0"&&(c.width=310,c.height=450,h.width=300,h.height=c.height-closeLabel.height-closeLabel.top-c.borderWidth*4),Ti.API.debug("Setting:["+Ti.UI.AUTOLINK_NONE+"]"),h.addEventListener("load",m),c.add(h),closeLabel.addEventListener("click",function(e){v()}),c.add(closeLabel),l.add(c),l.open();var r=Ti.UI.createAnimation();r.transform=Ti.UI.create2DMatrix(),r.duration=500,c.animate(r)},this.getAccessToken=function(e,t){f.tokenSecret=o;var n=d(e);n.parameters.push(["oauth_token",s]),n.parameters.push(["oauth_verifier",i]),OAuth.setTimestampAndNonce(n),OAuth.SignatureMethod.sign(n,f);var r=OAuth.getParameterMap(n.parameters);for(var l in r)Ti.API.debug(l+": "+r[l]);var c=Ti.Network.createHTTPClient();c.onload=function(){var e=OAuth.getParameterMap(c.responseText);u=e.oauth_token,a=e.oauth_token_secret,Ti.API.debug("*** get access token, Response: "+c.responseText),v(),t()},c.onerror=function(e){Ti.API.debug(e),v(),t()},c.open("POST",e,!0),c.send(r)};var g="OAuth realm,oauth_version,oauth_consumer_key,oauth_nonce,oauth_signature,oauth_signature_method,oauth_timestamp,oauth_token".split(","),y=function(e){var t="";for(var n=0,r=g.length;n<r;n++){var i=g[n];e[i]!=undefined&&(t+=i+'="'+encodeURIComponent(e[i])+'",')}return Ti.API.debug("authorization header string : "+t),t},b=function(e){var t=g.join(",")+",";for(var n in e)t.indexOf(n+",")>=0&&delete e[n]},w=function(e,t){var n=g.join(",")+",",r=[],i=[];for(var s=0,o=t.length;s<o;s++){var u=t[s];n.indexOf(u[0]+",")<0?r.push(encodeURIComponent(u[0])+"="+encodeURIComponent(u[1])):i.push[u]}return t=i,r.length?(r=r.join("&"),[e+(e.indexOf("?")>=0?"&":"?")+r,t]):[e,t]},E=function(e,t){var n=[],r=[];for(var i in t)n.push(encodeURIComponent(i)+"="+encodeURIComponent(t[i]));return n.sort(),n.length?(n=n.join("&"),e+(e.indexOf("?")>=0?"&":"?")+n):e},S=function(e){var t=e.url,n=e.parameters||[],r=e.title,i=e.method||"POST",s=e.resultByXML||!1;Ti.API.debug("Sending a message to the service at ["+t+"] with the following params: "+JSON.stringify(n));if(!this.isAuthorized()){Ti.API.debug("The send status cannot be processed as the client doesn't have an access token. ");return}f.tokenSecret=a;var o=d(t,i);o.parameters.push(["oauth_token",u]);for(c in n)o.parameters.push(n[c]);OAuth.setTimestampAndNonce(o),OAuth.SignatureMethod.sign(o,f);var l=OAuth.getParameterMap(o.parameters);for(var c in l)Ti.API.debug(c+": "+l[c]);i=="GET"&&(t=E(t,l),l=null,Ti.API.debug("url for GET:"+t));var h=Ti.Network.createHTTPClient();h.onload=function(){Ti.API.debug("*** sendStatus, Response: ["+h.status+"] "+h.responseText),(""+h.status).match(/^20[0-9]/)?e.onSuccess&&e.onSuccess(h.responseText):e.onError&&e.onError({error:"["+h.status+"] "+h.responseText})},h.onerror=function(t){Ti.API.debug(t),e.onError&&e.onError(t)},h.open(i,t,!0),h.send(l)};this.send=S}